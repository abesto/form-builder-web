/*
 * Copyright 2009 Nagy Zolt√°n
 *
 * This file is part of FormBuilder.
 *
 * FormBuilder is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * FormBuilder is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with FormBuilder.  If not, see <http://www.gnu.org/licenses/>.
 *
 */
var $selected=null;var can_preview=false;var editor=null;var cache={forms:Array(),preview:function(c,a){if(c=="add_command"){return}var b=$("#preview-form");if(this.forms[c]!=undefined){b.html(this.forms[c].html);$("#preview-html-inner").html(make_html(this.forms[c].html));b.fadeIn("slow")}else{check_rights("",false,c);if(can_preview===false){return}$.blockUI({message:downloading+"...",css:{"z-index":2000}});b.load(forms_url+"load",{id:c},function(d){$.unblockUI({onUnblock:function(){cache.forms[c]={html:d,name:a};$("#preview-html-inner").html(make_html(cache.forms[c].html))}})},"text")}},clear_preview:function(){$("#preview-form, #preview-html-inner").html("")},update:function(c,a,b){if(this.forms[c]===undefined){this.forms[c]={name:"",html:"<form></form>"}}this.forms[c].name=a;if(b!==null){this.forms[c].html=b}set_name(c,a);if(($selected!=null)&&(get_id($selected)==c)){this.preview(c)}}};function check_rights(callback,write,id){var data={write:write};if(id!==false){data.id=id}$.ajaxSetup({async:false});$.post(forms_url+"remote_check_rights",data,function(resp){$.ajaxSetup({async:true});if(resp=="NOT_LOGGED_IN"){window.location=base_url+"login";throw"User is not logged in - redirecting to login page"}else{if(resp=="FORM_NOT_FOUND"){$.blockUI({message:not_found,css:{"z-index":2000}});remove_row(id);setTimeout($.unblockUI,2000);can_preview=false}else{if(resp=="OK"){eval(callback);can_preview=true}else{throw ("Unknown response from server")}}}},"text")}function get_name(a){return $("#"+a+" td:first-child").html()}function set_name(b,a){return $("#"+b+" td:first-child").html(a)}function get_id(a){if(a==null){return null}return a.attr("id")}function toggle_public_icon(d,a){var c="famfamfam_silk/";var b="";if(a){c+="lock_open_go";b=public_label}else{c+="lock_delete";b=private_label}return action_icon(c,b,"set_public({id}, "+!a+")",d,true)}function action_icon(c,b,a,e,d){a=a.replace("{id}",e);return $("<img>").attr({src:base_url+"img/"+c+".png",alt:b}).click(function(f){check_rights(a,d,e)})}function add_row(e,c,b){var a=$("<tr>").attr("id",e).append($("<td>").append(c)).append($("<td>").addClass("actions").append(action_icon("tango/document-properties",edit,"open_editor({id})",e,false)).append(action_icon("tango/accessories-text-editor",rename,"rename_dialog({id})",e,true)).append(toggle_public_icon(e,b)).append(action_icon("tango/emblem-unreadable",remove,"remove_dialog({id})",e,true)).append($("<div>").append("&nbsp;")));var d=$("#forms tr");a.find("td").hide();$(d[d.length-1]).before(a);a.find("td").fadeIn("slow")}function add_row_public(id,form_name,user_name,owner,logged_in){var $row=$("<tr>").attr("id",id).append($("<td>").append(form_name)).append($("<td>").append(user_name)).append($("<td>").append("&nbsp;").addClass("actions").append($("<div>").append("&nbsp;")));with($row.find("td.actions div")){if(logged_in){before(action_icon("tango/document-properties",edit,"open_editor({id})",id,false));if(owner){before(action_icon("tango/accessories-text-editor",rename,"rename_dialog({id})",id,true));before(action_icon("tango/emblem-unreadable",this.remove,"remove_dialog({id})",id,true))}}}var rows=$("#forms tr");$row.find("td").hide();$(rows[rows.length-1]).before($row);$row.find("td").fadeIn("slow")}function remove_row(a){if(a==get_id($selected)){cache.clear_preview()}$("#"+a).fadeOut("slow",function(){$(this).remove()})}function open_editor(a){window.open(base_url+"builder/"+a,"builder_app")}function rename_dialog(a){$("#rename_form")[0].id.value=a;$("#rename_form #old_name").html(get_name(a));$("#rename_dialog").dialog("open").find("input[type=text]").focus()}function rename_form(){var b=$("#rename_form")[0];var c=b.id.value;var a=b.new_name.value;$.post(base_url+"my_forms/rename",{id:c,name:a});$("#rename_dialog").dialog("close").find("input[name=new_name]").val("");set_name(c,a)}function new_dialog(a){$("#new_form")[0].id.value=a;$("#new_dialog").dialog("open").find("input[type=text]").focus()}function new_form(){var b=$("#new_form")[0];var a=b.name.value;$.post(forms_url+"create",{name:a},function(c){cache.update(c,a,"<form></form>");add_row(c,a);select_id(c);$("#new_dialog").dialog("close").find("input[name=name]").val("");open_editor(c)})}function remove_dialog(a){$("#remove_form")[0].id.value=a;$("#remove_dialog").dialog("open").find("input[type=text]").focus()}function remove_form(){var a=$("#remove_form")[0];var b=a.id.value;$.post(base_url+"my_forms/remove",{id:b},function(c){remove_row(b);$("#remove_dialog").dialog("close")})}function set_public(id,to){$.post(base_url+"my_forms/set_public",{id:id,to:to},function(){with($("#"+id+" td.actions")){var $img=toggle_public_icon(id,to);find("img:nth-child(3)").after($img).remove();find("div").html($img.attr("alt"))}})}function make_html(a){a=htmlize($(a)[0],0);a=a.replace(/ *<tbody>.*\n/g,"");a=a.replace(/ *<\/tbody>.*\n/g,"");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");return a}function select(a){if(get_id(a)==="add_command"){return}if($selected!=null){$selected.removeClass("selected")}$selected=a;$selected.addClass("selected");cache.preview(get_id(a))}function select_id(a){select($("#"+a))}$(document).ready(function(){$.ajaxSetup({cache:false});$("#forms tr:gt(0)").livequery(function(){$(this).hover(function(){$(this).addClass("hovered")},function(){$(this).removeClass("hovered")}).click(function(d){if(d.target.parentNode==this){select($(this))}})});$("#forms tr:gt(0):odd").livequery(function(){$(this).removeClass("even").addClass("odd")});$("#forms tr:gt(0):even").livequery(function(){$(this).removeClass("odd").addClass("even")});$("#forms td.actions img").livequery(function(){$(this).hover(function(){$(this).parent().find("div").html($(this).attr("alt")).css("color","inherit")},function(){$(this).parent().find("div").css("color","transparent")})});$.post(forms_url+"list_forms",Array(),function(d){if(is_public){for(var e in d.forms){var f=d.forms[e];add_row_public(f.id,f.name,f.user_name,f.owner,d.logged_in)}}else{for(var e in d){add_row(d[e]["id"],d[e]["name"],d[e]["public"]=="1")}}},"json");var c={};c[cancel]=function(){$(this).dialog("close")};c[create]=function(){$(this).find("form").submit()};$("#new_dialog").dialog({autoOpen:false,modal:true,width:"auto",buttons:c});$("#new_form").submit(function(){check_rights("new_form()",true,false);return false});var b={};b[cancel]=function(){$(this).dialog("close")};b[rename]=function(){$(this).find("form").submit()};$("#rename_dialog").dialog({autoOpen:false,modal:true,width:"auto",buttons:b});$("#rename_form").submit(function(){check_rights("rename_form()",true,this.id.value);return false});var a={};a[cancel]=function(){$(this).dialog("close")};a[remove]=function(){$(this).find("form").submit()};$("#remove_dialog").dialog({autoOpen:false,modal:true,buttons:a});$("#remove_form").submit(function(){check_rights("remove_form()",true,this.id.value);return false});$("#preview").tabs();$("#preview").tabs("select","#preview-form");$.blockUI.defaults.css.padding="15px";$.blockUI.defaults.css.border="none";$.blockUI.defaults.css.backgroundColor="#888";$.blockUI.defaults.css["-webkit-border-radius"]="10px";$.blockUI.defaults.css["-moz-border-radius"]="10px";$.blockUI.defaults.css.color="#fff";$.blockUI.defaults.css["font-family"]="sans"});
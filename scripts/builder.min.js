const LEFT=100;const RIGHT=101;const UP=102;const DOWN=103;const WrongDir=new Error("Wrong direction");function call_action(fun){dirty=true;eval("ACTIONS."+fun)}const ACTIONS={add_fieldset:function(){var b=$("<fieldset>").append($("<legend>"));$('#form').append(b);b.select()},remove_fieldset:function(){check_selected_type("fieldset").remove();update_actions("none");update_props("none")},add_table:function(){var a=check_selected_type(Array("form","fieldset"));var b=$("<td>");a.append($("<table>").append($("<tr>").append(b)));b.select()},remove_table:function(){check_selected_type("table").remove()},create_cell:function(b){var a=check_selected_type("td");var c=a.parent();var d=$("<td>");if(b==RIGHT){d.insertAfter(a)}else{if(b==LEFT){d.insertBefore(a)}else{throw WrongDir}}d.select();update_actions("td");update_props("td")},create_row:function(b){var a=check_selected_type("td");var c=a.parent();var e=$("<td>");var d=$("<tr>").append(e);if(b==DOWN){d.insertAfter(c)}else{if(b==UP){d.insertBefore(c)}else{throw WrongDir}}e.select()},merge_cells:function(d){var c=check_selected_type("td");var f=c.parent();var h;if(d==LEFT){var b=c.prev();if((get_td_type(c)=="text")&&(get_td_type(b)=="text")){b.append(" "+c.html())}else{b.html(c.html())}h=c;c=b;b.addClass("selected")}else{if(d==RIGHT){var a=c.next();if((get_td_type(c)=="text")&&(get_td_type(a)=="text")){c.append(" "+a.html())}h=a}else{throw WrongDir}}h.remove();var g=get_int_attrib(c,"colspan");var e=get_int_attrib(h,"colspan");c.attr("colspan",g+e);update_actions("td");update_props("td")},split_cell:function(b){var d=$("<td>");var a=check_selected_type("td");var c=a.parent();a.attr("colspan",get_int_attrib(a,"colspan")-1);if(b==LEFT){d.insertBefore(a)}else{if(b==RIGHT){d.insertAfter(a)}else{throw WrongDir}}update_actions("td");update_props("td")},remove_cell:function(){var b=check_selected_type("td");var c=b.parent();var a=c.parent().parent();b.remove();if(c.children().size()==0){c.remove()}if(a.find("tr").size()==0){a.remove()}update_actions("none");update_props("none")}};const actions={td:function(){var b=$(check_selected_type("td"));var a=Array("create_cell(LEFT)","create_cell(RIGHT)","create_row(UP)","create_row(DOWN)","br");if(b.prev().attr("rowspan")==b.attr("rowspan")){a.push("merge_cells(LEFT)")}if(b.next().attr("rowspan")==b.attr("rowspan")){a.push("merge_cells(RIGHT)")}if(a[a.length-1]!="br"){a.push("br")}if(b.attr("colspan")>1){a=a.concat(Array("split_cell(LEFT)","split_cell(RIGHT)"));a.push("br")}a.push("remove_cell()");return a},table:function(){check_selected_type("table");return Array("remove_table()")},fieldset:function(){check_selected_type("fieldset");return Array("add_table()","remove_fieldset()")}};var trans;var $hovered=$("#main form");var main_start=0;function update_actions(c){var d=$("#actions_fs");$("#actions_fs input, #actions_fs > span, #actions_fs br").remove();if(c=="none"){return}var e=actions[c];if(!e){e=function(){return Array()}}e=e();if(e.length>0){e.push("br")}e.push("add_fieldset()");for(var b=0;b<e.length;b++){var a=e[b];if(a=="br"){d.append($("<br />"));continue}d.append($("<input>").attr({type:"button",name:a,value:trans.actions[a],onclick:'call_action("'+a+'")'}))}}function update_props(i){$("#props_form fieldset").remove();$("#props_form > span").remove();var c=$("#props_form");if(i=="none"){return}var g=props[i];if(!g){$("#props_form").append(node_with_text("span",trans.no_props("<strong>"+i+"</strong>")));return}g=g();var d=g.get_groups();for(var h=0;h<d.length;h++){var k=d[h];var f=$("<fieldset>").attr("id",k).append($("<legend>").append(trans.prop_groups[k]));c.append(f);var m=$("<table>");f.append(m);var j=g.get_props(k);for(var e=0;e<j.length;e++){var a=j[e];var l=trans.prop_names[a.name];if(l==undefined){l=a.name}var b=a.render();m.append($("<tr>").append($("<td>").append(l)).append($("<td>").append(b)));if(a.focus){if(b[0].nodeName!="INPUT"){b.children("input[type=text]").focus()}else{b.focus()}}}}}function hover(){$hovered.unbind("click");$hovered.removeClass("hovered");$(this).addClass("hovered").click(select_hovered);$hovered=$(this)}function unhover(){$hovered.unbind("click");$hovered.removeClass("hovered");var a=$hovered[0].parentNode.nodeName;if((a!="INPUT")&&(a!="TD")&&(a!="FORM")&&(a!="TABLE")){$hovered=$($hovered[0].parentNode);while((a=="TBODY")||(a=="TR")){$hovered=$($hovered[0].parentNode);a=$hovered[0].nodeName}$hovered.addClass("hovered").click(select_hovered)}}function select_hovered(){$(this).select()}$.fn.select=function(){$(".selected").removeClass("selected");var a=$(this);a.addClass("selected");var b=a[0].nodeName.toLowerCase();update_actions(b);update_props(b)};function set_lang(lang){trans=eval("TRANS."+lang);$("#actions_fs legend").html(trans.actions_label);$("#props_form fieldset legend").html(trans.props);var prop_groups=$("#props_form fieldset");for(var i=0;i<prop_groups.length;i++){prop_groups[i].firstChild.innerHTML=trans.prop_groups[prop_groups[i].getAttribute("id")]}var selected=$(".selected")[0];if(selected){var name=selected.nodeName.toLowerCase();update_actions(name);update_props(name)}$("#menu_label").html(trans.menu.menu);$("#save_button").val(trans.menu.save);$("#user_label").html(trans.login.user+":");$("#pass_label").html(trans.login.pass+":");var login_buttons={};login_buttons[trans.menu.cancel]=function(){$(this).dialog("close")};login_buttons[trans.login.login]=function(){$(this).find("form").submit()};$("#login_dialog").dialog("option",{title:trans.login.login,buttons:login_buttons});$("#save_as_button").val(trans.save_as.save_as);$("#save_as_dialog #name_label").html(trans.save_as.name+":");var save_as_buttons={};save_as_buttons[trans.menu.cancel]=function(){$(this).dialog("close")};save_as_buttons[trans.save_as.save_as]=function(){$(this).find("form").submit()};$("#save_as_dialog").dialog("option",{title:trans.save_as.save_as,buttons:save_as_buttons});status.update_lang()}function make_html(){var b=htmlize($("#main form")[0],0);b=b.replace(/ *<tbody>.*\n/g,"");b=b.replace(/ *<\/tbody>.*\n/g,"");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");var a=$("#html");a.html("<pre>"+b+"</pre>").dialog("option","title",$("#title").html()+" HTML");a.dialog("open");if(a.width()<300){a.css({width:"300px"})}}$(document).ready(function(){$("#main").height($(window).height()-$("#actions").height());$("#props").resizable({handles:"w",ghost:true,stop:function(event,ui){$("#main").width($("body").width()-ui.size.width);$("#actions").width($("body").width()-ui.size.width)}});$("#main td, #main table, #main fieldset").livequery(function(){$(this).hover(hover,unhover)}).livequery(function(){if($(this).hasClass("hovered")){$(this).select()}});$("body input").livequery("change",function(){this.value=trim(this.value)});$("#main input[type=checkbox], #main input[type=radio]").change(function(){if(this.checked){this.setAttribute("checked","checked")}});var lang=$("#lang");for(var i=0;i<TRANS.list.length;i++){var id=TRANS.list[i];var name=eval("TRANS."+id).name;var span=node_with_text("span",name).attr("id",id).click(function(){set_lang($(this).attr("id"))});lang.append(span)}$("#login_dialog").dialog({autoOpen:false,width:"auto",modal:true,open:function(){$(this).find("input").val("");$(this).find("input[name=user]").focus()}});$("#login_form").submit(function(){login();return false});$("#save_as_dialog").dialog({autoOpen:false,width:"auto",modal:true,open:function(){$(this).find("#old_name").html(get_title());$(this).find("input[name=new_name]").html("").focus()}});$("#save_as_form").submit(function(){save_as(this);return false});set_lang(default_lang);status.set("loaded");$("#html").dialog({autoOpen:false,width:"auto",modal:true,close:function(){update_props($(".selected")[0].nodeName.toLowerCase())}});$("#main form").select();window.focus()});function htmlize(g,h){var d=g.nodeName.toLowerCase();var c="";if(d=="tbody"){h-=1}if(d=="#text"){c+=g.textContent}else{for(var f=0;f<h;f++){c+="  "}c+="<"+d;var e=$(g);var b={input:Array("type","name","id","checked"),td:Array("colspan"),label:Array("for")};if(b[d]!=undefined){for(f=0;f<b[d].length;f++){var a=b[d][f];if((e.attr(a)!=undefined)&&(e.attr(a)!="")){c+=" "+a+'="'+e.attr(a)+'"'}}}if((d=="input")&&(e.attr("type")!="radio")&&(e.attr("type")!="checkbox")&&(e.attr("value")!="")){c+=' value="'+e.attr("value")+'"'}if(d=="input"){return c+" />\n"}c+=">"}if((g.childNodes!=undefined)&&(g.childNodes.length>0)&&(g.childNodes[0].nodeName!="#text")){c+="\n"}for(var f=0;f<g.childNodes.length;f++){c+=htmlize(g.childNodes[f],h+1)}if(d!="#text"){if((g.childNodes!=undefined)&&(g.childNodes.length>0)&&(g.childNodes[0].nodeName!="#text")){for(f=0;f<h;f++){c+="  "}}c+="</"+d+">\n"}return c}function handle_prop_change(){dirty=true}function Prop(a,b){this.name=a;this.dom=b;this.focus=false;this.render=function(){return $(this.dom)}}function PropsCollection(){this.groups=Array();this.props=new Object();this.add_group=function(a){this.groups.push(a);this.props[a]=Array()};this.add_prop=function(b,c,a){if(a){c.focus=true}this.props[b].push(c)};this.get_groups=function(){return this.groups};this.get_props=function(a){return this.props[a]};this.set_group=function(a,b){this.props[a]=b}}const PROPS={td_type:function(){var h=$("<span>");var a=check_selected_type("td");var f=Array("text","input|select");var b=a.children(":first-child");var e="";if(b.size()>0){e=b.get(0).nodeName.toLowerCase().replace("#","")}else{e="text"}for(var d=0;d<f.length;d++){var g=f[d];var c=$('<input type="radio" name="td_type" id="td_type_'+g+'" />').value(f[d]).change(function(){set_td_type($(this).value());handle_prop_change()});var j=trans.td_types[f[d]];if(f[d].match(e)){c.attr("checked","true")}h.append(c).append($("<label>").attr("for","td_type_"+g).append(j))}return h},input_type:function(){var b=$("<select>").attr("name","input_type");var a=check_selected_type("td");var d=Array("text","password","button","checkbox","radio","file","select");var e=get_input_type(a);for(var c=0;c<d.length;c++){var f=$("<option>").value(d[c]).append(trans.td_types[d[c]]);if(e==d[c]){f.attr("selected","true")}b.append(f)}b.change(function(){set_input_type(this.value);handle_prop_change()});return b},name:function(){var a=make_input("name","text");a.change(function(){set_name($(".selected"),this.value);handle_prop_change()});a.value($(".selected").firstChild().attr("name"));return a},legend:function(){var a=make_input("legend","text");a.change(function(){$(".selected").children("legend").html(this.value);handle_prop_change()});a.value($(".selected").children("legend").html());return a},option:function(num,text){var $option=$("<div>").append(make_input("option_"+num,"text").value(text).change(function(){with($(".selected select")){if(children("option").size()<=num){append($("<option>").attr("builder_id",num).html(this.value))}else{children("option[builder_id="+num+"]").html(this.value)}}handle_prop_change();update_props("td")}));if(text!=""){$option.append(make_input("remove_"+num,"button").value("-").click(function(){if($(".selected option").size()==1){$(".selected option").html("")}else{$(".selected option[builder_id="+num+"]").remove();var $options=$(".selected option");for(var i=0;i<$options.size();i++){$options.get(i).setAttribute("builder_id",i)}}handle_prop_change();update_props("td")}))}return $option}};const props={td:function(){var d=check_selected_type("td");var c=new PropsCollection();c.add_group("td");c.add_prop("td",new Prop("td_type",PROPS.td_type()));var f=get_td_type(d);var b=get_input_type(d);if(f=="input"||f=="select"){c.add_group("input");c.add_prop("input",new Prop("name",PROPS.name()));c.add_prop("input",new Prop("input_type",PROPS.input_type()))}var e=make_input("td_text","text");e.value(get_td_text(d));e.change(function(){set_td_text(d,this.value);handle_prop_change()});if(b=="file"){e.attr("disabled",true).value(trans.no_file_label)}if(f!="select"){c.add_prop("td",new Prop("td_text",e),true)}else{c.add_group("options");var a=d.firstChild().children();a.each(function(g){c.add_prop("options",new Prop("option",PROPS.option(g,$(this).html())),true)});if(a[0].innerHTML!=""){c.add_prop("options",new Prop("option",PROPS.option(a.size(),"")),true)}}return c},fieldset:function(){var b=check_selected_type("fieldset");var c=b.firstChild.innerHTML;var a=new PropsCollection();a.add_group("fieldset");a.add_prop("fieldset",new Prop("legend",PROPS.legend()),true);return a}};var dirty=false;function update_or_create(b){var a={id:form_id,write:true};$.post(base_url+"my_forms/remote_check_rights",a,function(c){if(c=="NOT_LOGGED_IN"){$("#login_dialog").dialog("open");$.data($("#login_form").get(0),"callback",b)}else{if((c=="FORM_NOT_FOUND")||(c=="OK")){b.call()}else{throw ("Unknown response from server")}}},"text")}function save(){update_or_create(function(){var a=$("#form").html();$.post(base_url+"my_forms/save",{id:form_id,name:get_title(),html:a},function(b){window.opener.cache.update(b,get_title(),"<form>"+a+"</form>");if(form_id!=b){if(is_public){window.opener.add_row_public(b,get_title(),user,true,true)}else{window.opener.add_row(b,get_title(),false)}window.opener.select_id(b);window.location=base_url+"builder/"+b}status.set("saved")},"text");dirty=false})}function save_as(b){var a=b.new_name.value;update_or_create(function(){var c=$("#form").html();$.post(base_url+"my_forms/create",{name:a,html:c},function(d){window.opener.add_row(d,a);window.opener.cache.update(d,a,"<form>"+c+"</form>");window.opener.select_id(d);window.location=base_url+"builder/"+d},"text");dirty=false})}function login(){var a=$("#login_form")[0];var b={user:a.user.value,pass:a.pass.value,lang:trans.code};$.post(base_url+"login/ajaj_do_login",b,function(c){if(c==true){$("#login_dialog").dialog("close");$.removeData(a)}else{$("#login_error").html(c)}},"json")}window.onbeforeunload=save_check;function save_check(){if(dirty==true){return trans.leave_confirm}return null}const TRANS={list:Array("en","hu"),en:{name:"English",code:"en",wrong_node:function(a){return"Selected node is not a(n) "+a},no_actions:function(a){return"No actions for node "+a},no_props:function(a){return"No properties for node "+a},actions_label:"Actions",props:"Properties",no_file_label:"No label",leave_confirm:"There are unsaved changes on this form. Are you sure you want to leave?",menu:{cancel:"Cancel",menu:"Menu",save:"Save"},save_as:{save_as:"Save as",name:"New name"},login:{user:"Username",pass:"Password",login:"Login"},status:{saved:"Form saved",loaded:"Form loaded"},prop_groups:{input:"Input field",td:"Table cell",fieldset:"Fieldset",form:"Form",options:"Values"},prop_names:{td_type:"Content type:",input_type:"Input field type:",td_text:"Text:",label:"Label:",name:"Name:",legend:"Legend:",form_name:"Form name:",option:""},td_types:{text:"Text",password:"Password","input|select":"Input",button:"Button",checkbox:"Checkbox",radio:"Radio button",file:"File",select:"Drop-down menu"},actions:{"create_cell(LEFT)":"New cell (left)","create_cell(RIGHT)":"New cell (right)","create_row(UP)":"New row (above)","create_row(DOWN)":"New row (below)","remove_cell()":"Remove cell","merge_cells(LEFT)":"Merge cells (left)","merge_cells(RIGHT)":"Merge cells (right)","split_cell(LEFT)":"Split cell (from the left)","split_cell(RIGHT)":"Split cell (from the right)","add_table()":"Add table","add_fieldset()":"Add fieldset","remove_table()":"Remove table","remove_fieldset()":"Remove fieldset"}},hu:{name:"Magyar",code:"hu",wrong_node:function(a){return"A kiválasztott elem nem "+a},no_actions:function(a){return"Nincs művelet a(z) "+a+" elemhez"},no_props:function(a){return"A(z) "+a+" elemnek nincsenek beállítható tulajdonságai"},actions_label:"Műveletek",props:"Tulajdonságok",no_file_label:"Nincs felirat",leave_confirm:"Az űrlapon mentetlen változások vannak. Biztosan el kívánja hagyni az oldalt?",menu:{cancel:"Mégsem",menu:"Menü",save:"Mentés"},save_as:{save_as:"Mentés másként",name:"Az új űrlap neve"},login:{user:"Felhasználónév",pass:"Jelszó",login:"Bejelentkezés"},status:{saved:"Űrlap elmentve",loaded:"Űrlap betöltve"},prop_groups:{td:"Cella",input:"Beviteli mező",fieldset:"Fieldset",form:"Űrlap",options:"Értékek"},prop_names:{td_type:"Cella típusa:",input_type:"Beviteli mező típusa:",td_text:"Szöveg:",label:"Felirat:",name:"Mezőnév:",legend:"Felirat:",form_name:"A form neve:",option:""},td_types:{text:"Szöveg",password:"Jelszó","input|select":"Beviteli mező",button:"Gomb",checkbox:"Checkbox",radio:"Radio",file:"Fájl",select:"Lenyíló menü"},actions:{"create_cell(LEFT)":"Új cella (balra)","create_cell(RIGHT)":"Új cella (jobbra)","create_row(UP)":"Új sor (fel)","create_row(DOWN)":"Új sor (le)","remove_cell()":"Cella törlése","merge_cells(LEFT)":"Cellák egyesítése (balra)","merge_cells(RIGHT)":"Cellák egyesítése (jobbra)","split_cell(LEFT)":"Cella felosztása (balról)","split_cell(RIGHT)":"Cella felosztása (jobbról)","add_table()":"Új táblázat","add_fieldset()":"Új fieldset","remove_table()":"Táblázat eltávolítása","remove_fieldset()":"Fieldset eltávolítása"}}};$.fn.firstChild=function(){return $(this).children(":first-child")};function trim(a){return a.replace(/^\s+|\s+$/g,"")}$.fn.value=function(a){if(a==undefined){return $(this).val()}else{return $(this).val(trim(a))}};$.fn.html=function(a){return a===undefined?(this[0]?this[0].innerHTML.replace(/ jQuery\d+="(?:\d+|null)"/g,""):null):this.empty().append(trim(a))};function check_selected_type(c){var b=$(".selected")[0];if(typeof(c)=="string"){c=Array(c)}for(var a=0;a<c.length;a++){if($.nodeName(b,c[a])){return $(b)}}throw new Error(trans.wrong_node(c));return $(b)}function node_with_text(a,b){return $("<"+a+">").append(b)}function make_input(a,b){return $("<input />").attr({type:b,name:a})}function get_td_type(a){if(a.firstChild().size()==0){return"text"}if(a.firstChild()[0].nodeName=="#text"){return"text"}if(a.firstChild()[0].nodeName=="INPUT"){return"input"}if(a.firstChild()[0].nodeName=="SELECT"){return"select"}return false}function set_name(c,b){var e=c.firstChild();if(b==""){e.removeAttr("name").removeAttr("id");return}var a=1;$("#main input[id^="+b+"]").each(function(){if($(this).attr("id")==b+"_"+a){a+=1}});var d=b+"_"+a;e.attr({name:b,id:d});e.next().attr("for",d)}function get_input_type(b){var c=b.firstChild();var a=get_td_type(b);if(a=="text"){return"none"}else{if(a=="select"){return"select"}else{return c.attr("type")}}}function get_int_attrib(a,b){var c=a.attr(b);if(!c){return 1}return parseInt(c)}function get_td_text(e){var d="";var b=check_selected_type("td");var c=get_td_type(e);if(c=="text"){d=b.html()}else{if(c=="input"){var a=e.firstChild().attr("type");if((a=="text")||(a=="button")||(a=="password")){d=e.firstChild().value()}else{if((a=="radio")||(a=="checkbox")){d=e.text()}}}else{if(c=="select"){if(e.find("option").size()>0){d=e.find("option").get(0).innerHTML}else{return""}}}}return d}function set_td_text($td,_text){var type=get_td_type($td);_text=_text.replace(/^\s+|\s+$/g,"");if(type=="text"){$td.html(_text)}else{if(type=="input"){type=$td.firstChild().attr("type");if($td.children().size()==2){$td.children(":last-child").remove()}if((type=="text")||(type=="button")||(type=="password")){$td.firstChild().value(_text)}else{if((type=="radio")||(type=="checkbox")){var label=node_with_text("label",_text);label.attr("for",$td.firstChild().attr("id"));$td.append(label)}}}else{if(type=="select"){with($td.children("select")){children().remove();append('<option builder_id="0">'+_text+"</option>")}}}}}function set_input_type(c){var e=check_selected_type("td");var d=get_td_text(e);var a=get_input_type(e);var f=null;if((a=="select")&&(c!="select")){f=$('<input type="'+c+'">')}else{if((a!="select")&&(c=="select")){f=$("<select>")}}if((a!="select")&&(c!="select")){f=e.firstChild();f.get(0).setAttribute("type",c)}else{var b=e.firstChild();f.attr("name",b.attr("name")).attr("id",b.attr("id"));e.children().remove();e.append(f)}if(c=="text"){f.change(function(){update_props("td")})}else{f.unbind("change")}set_td_text(e,d);if((c=="file")||(a=="file")||(a=="select")||(c=="select")){update_props("td")}}function set_td_type(b){var a=check_selected_type("td");var c=get_td_text(a);if(b=="text"){a.html("")}else{if(b=="input|select"){var d=make_input("","text");d.change(function(){update_props("input")});a.html("").append(d)}}set_td_text(a,c);update_props("td")}function get_title(){return $("#title").html()}function set_title(a){$("#title").html(a);$("title").html(a+" - FormBuilder");handle_prop_change()}var status={date:new Date(),status:null,set:function(a){this.status=a;this.date=new Date();$("#status").html(this.date.toLocaleString()+": "+trans.status[a])},update_lang:function(){$("#status").html(this.date.toLocaleString()+": "+trans.status[this.status])}};
